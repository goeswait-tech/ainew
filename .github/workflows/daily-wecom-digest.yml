name: Daily WeCom AI Digest

on:
  workflow_dispatch:
  schedule:
    # GitHub Actions 定时触发在整点更容易延迟/丢触发；避开 :00 提高稳定性
    - cron: "7 1 * * *" # 09:07 Asia/Shanghai

permissions:
  contents: read

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare OPML (optional)
        env:
          FOLLOW_OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          mkdir -p feeds
          if [ -n "$FOLLOW_OPML_B64" ]; then
            echo "$FOLLOW_OPML_B64" | base64 --decode > feeds/follow.opml
            echo "Loaded feeds/follow.opml from FOLLOW_OPML_B64 secret"
          else
            echo "No FOLLOW_OPML_B64 secret provided; RSS OPML is optional"
          fi

      - name: Refresh snapshot for today's digest
        run: |
          if [ -f feeds/follow.opml ]; then
            python scripts/update_news.py --output-dir data --window-hours 24 --rss-opml feeds/follow.opml
          else
            python scripts/update_news.py --output-dir data --window-hours 24
          fi

      - name: Send WeCom digest
        env:
          WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
          DIGEST_SITE_URL: ${{ vars.DIGEST_SITE_URL }}
          WECOM_KEYWORD: AI新闻雷达
        run: |
          python scripts/send_wecom_digest.py \
            --input data/latest-24h.json \
            --top-n 12 \
            --keyword "$WECOM_KEYWORD" \
            --site-url "$DIGEST_SITE_URL"

      - name: Send PushDeer digest (optional)
        env:
          PUSHDEER_PUSHKEY: ${{ secrets.PUSHDEER_PUSHKEY }}
          PUSHDEER_SERVER: ${{ vars.PUSHDEER_SERVER }}
          DIGEST_SITE_URL: ${{ vars.DIGEST_SITE_URL }}
        run: |
          python scripts/send_pushdeer_digest.py \
            --input data/latest-24h.json \
            --top-n 12 \
            --site-url "$DIGEST_SITE_URL" \
            --server "${PUSHDEER_SERVER:-https://api2.pushdeer.com}" \
            --skip-if-missing
