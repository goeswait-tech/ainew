name: Update AI News Snapshot

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare OPML (optional)
        env:
          FOLLOW_OPML_B64: ${{ secrets.FOLLOW_OPML_B64 }}
        run: |
          mkdir -p feeds
          if [ -n "$FOLLOW_OPML_B64" ]; then
            echo "$FOLLOW_OPML_B64" | base64 --decode > feeds/follow.opml
            echo "Loaded feeds/follow.opml from FOLLOW_OPML_B64 secret"
          else
            echo "No FOLLOW_OPML_B64 secret provided; RSS OPML is optional"
          fi

      - name: Update data
        run: |
          if [ -f feeds/follow.opml ]; then
            python scripts/update_news.py --output-dir data --window-hours 24 --rss-opml feeds/follow.opml
          else
            python scripts/update_news.py --output-dir data --window-hours 24
          fi

      - name: Decide whether to send WeCom digest (scheduled runs only)
        id: wecom_gate
        if: ${{ github.event_name == 'schedule' }}
        run: |
          bj_time=$(TZ=Asia/Shanghai date '+%H:%M')
          bj_hour=$(TZ=Asia/Shanghai date '+%H')
          bj_min=$(TZ=Asia/Shanghai date '+%M')
          should_send=false
          # Allow GitHub scheduler delays: if the half-hour snapshot job starts a few minutes late, still send.
          if [ "$bj_hour" = "09" ] && [ "$bj_min" -le 15 ]; then
            should_send=true
          fi
          # Target 20:10 Beijing; snapshot runs every 30 min, so use the 20:00 scheduled run
          # and allow delayed starts into the 20:25 window.
          if [ "$bj_hour" = "20" ] && [ "$bj_min" -ge 10 ] && [ "$bj_min" -le 25 ]; then
            should_send=true
          fi
          echo "Beijing time now: $bj_time"
          echo "should_send=$should_send" >> "$GITHUB_OUTPUT"

      - name: Send WeCom digest (on snapshot schedule)
        if: ${{ github.event_name == 'schedule' && steps.wecom_gate.outputs.should_send == 'true' }}
        env:
          WECOM_WEBHOOK_URL: ${{ secrets.WECOM_WEBHOOK_URL }}
          DIGEST_SITE_URL: ${{ vars.DIGEST_SITE_URL }}
          WECOM_KEYWORD: AI新闻雷达
        run: |
          python scripts/send_wecom_digest.py \
            --input data/latest-24h.json \
            --top-n 12 \
            --keyword "$WECOM_KEYWORD" \
            --site-url "$DIGEST_SITE_URL"

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/latest-24h.json data/archive.json data/source-status.json data/waytoagi-7d.json data/title-zh-cache.json
          git commit -m "chore: update ai news snapshot"
          git push
